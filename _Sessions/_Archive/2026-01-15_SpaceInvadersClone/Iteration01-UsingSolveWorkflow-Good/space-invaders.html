<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Invaders</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Courier New', monospace;
        }
        #gameContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #gameCanvas {
            border: 2px solid #33ff33;
            image-rendering: pixelated;
        }
        #instructions {
            color: #33ff33;
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="672" height="768"></canvas>
        <div id="instructions">
            ARROW KEYS or A/D to move | SPACE to fire | ENTER to start
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Original Space Invaders resolution: 224x256, scaled 3x
        const SCALE = 3;
        const GAME_WIDTH = 224;
        const GAME_HEIGHT = 256;
        canvas.width = GAME_WIDTH * SCALE;
        canvas.height = GAME_HEIGHT * SCALE;
        ctx.scale(SCALE, SCALE);
        ctx.imageSmoothingEnabled = false;

        // Colors (original arcade used white/green phosphor)
        const COLOR_WHITE = '#FFFFFF';
        const COLOR_GREEN = '#33FF33';
        const COLOR_RED = '#FF3333';
        const COLOR_CYAN = '#33FFFF';
        const COLOR_YELLOW = '#FFFF33';
        const COLOR_MAGENTA = '#FF33FF';

        // Game state
        let gameState = 'start'; // start, playing, gameover
        let score = 0;
        let highScore = parseInt(localStorage.getItem('spaceInvadersHighScore')) || 0;
        let lives = 3;
        let level = 1;

        // Timing (original ran at ~60Hz with specific frame counts)
        let frameCount = 0;
        const BASE_ALIEN_MOVE_DELAY = 55; // frames between alien movements
        let alienMoveDelay = BASE_ALIEN_MOVE_DELAY;
        let lastAlienMoveFrame = 0;

        // Player
        const player = {
            x: 112 - 8,
            y: 216,
            width: 16,
            height: 8,
            speed: 1,
            alive: true,
            exploding: false,
            explodeFrame: 0
        };

        // Player bullet
        const playerBullet = {
            x: 0,
            y: 0,
            width: 1,
            height: 4,
            active: false,
            speed: 4
        };

        // Alien bullets (max 3 at a time like original)
        const alienBullets = [];
        const MAX_ALIEN_BULLETS = 3;
        let alienShootTimer = 0;
        const ALIEN_SHOOT_DELAY = 48;

        // Aliens - 5 rows, 11 columns
        const ALIEN_ROWS = 5;
        const ALIEN_COLS = 11;
        const ALIEN_WIDTH = 12;
        const ALIEN_HEIGHT = 8;
        const ALIEN_SPACING_X = 16;
        const ALIEN_SPACING_Y = 16;
        let aliens = [];
        let alienDirection = 1; // 1 = right, -1 = left
        let alienMoveAmount = 2;
        let alienDropAmount = 8;
        let needToDrop = false;
        let alienAnimFrame = 0;

        // UFO (Mystery Ship)
        const ufo = {
            x: 0,
            y: 32,
            width: 16,
            height: 7,
            active: false,
            direction: 1,
            speed: 1
        };
        let ufoTimer = 0;
        const UFO_SPAWN_MIN = 1500;
        const UFO_SPAWN_MAX = 3000;
        let nextUfoSpawn = UFO_SPAWN_MIN + Math.random() * (UFO_SPAWN_MAX - UFO_SPAWN_MIN);
        const UFO_SCORES = [50, 100, 150, 100, 300, 100, 100, 50, 150, 100, 100, 50, 150, 100, 100, 300];
        let ufoScoreIndex = 0;
        let ufoScoreDisplay = { active: false, x: 0, score: 0, timer: 0 };

        // Shields/Bunkers
        const SHIELD_COUNT = 4;
        const SHIELD_WIDTH = 22;
        const SHIELD_HEIGHT = 16;
        const SHIELD_Y = 192;
        let shields = [];

        // Shield pixel pattern (original arcade pattern)
        const shieldPattern = [
            [0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],
            [0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],
            [0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1],
            [1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1],
            [1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1]
        ];

        // Sprite definitions (pixel art)
        const sprites = {
            // Squid (top row) - 8x8
            squid: [
                [[0,0,0,1,1,0,0,0],
                 [0,0,1,1,1,1,0,0],
                 [0,1,1,1,1,1,1,0],
                 [1,1,0,1,1,0,1,1],
                 [1,1,1,1,1,1,1,1],
                 [0,0,1,0,0,1,0,0],
                 [0,1,0,1,1,0,1,0],
                 [1,0,1,0,0,1,0,1]],
                [[0,0,0,1,1,0,0,0],
                 [0,0,1,1,1,1,0,0],
                 [0,1,1,1,1,1,1,0],
                 [1,1,0,1,1,0,1,1],
                 [1,1,1,1,1,1,1,1],
                 [0,1,0,1,1,0,1,0],
                 [1,0,0,0,0,0,0,1],
                 [0,1,0,0,0,0,1,0]]
            ],
            // Crab (middle rows) - 11x8
            crab: [
                [[0,0,1,0,0,0,0,0,1,0,0],
                 [0,0,0,1,0,0,0,1,0,0,0],
                 [0,0,1,1,1,1,1,1,1,0,0],
                 [0,1,1,0,1,1,1,0,1,1,0],
                 [1,1,1,1,1,1,1,1,1,1,1],
                 [1,0,1,1,1,1,1,1,1,0,1],
                 [1,0,1,0,0,0,0,0,1,0,1],
                 [0,0,0,1,1,0,1,1,0,0,0]],
                [[0,0,1,0,0,0,0,0,1,0,0],
                 [1,0,0,1,0,0,0,1,0,0,1],
                 [1,0,1,1,1,1,1,1,1,0,1],
                 [1,1,1,0,1,1,1,0,1,1,1],
                 [1,1,1,1,1,1,1,1,1,1,1],
                 [0,1,1,1,1,1,1,1,1,1,0],
                 [0,0,1,0,0,0,0,0,1,0,0],
                 [0,1,0,0,0,0,0,0,0,1,0]]
            ],
            // Octopus (bottom rows) - 12x8
            octopus: [
                [[0,0,0,0,1,1,1,1,0,0,0,0],
                 [0,1,1,1,1,1,1,1,1,1,1,0],
                 [1,1,1,1,1,1,1,1,1,1,1,1],
                 [1,1,1,0,0,1,1,0,0,1,1,1],
                 [1,1,1,1,1,1,1,1,1,1,1,1],
                 [0,0,0,1,1,0,0,1,1,0,0,0],
                 [0,0,1,1,0,1,1,0,1,1,0,0],
                 [1,1,0,0,0,0,0,0,0,0,1,1]],
                [[0,0,0,0,1,1,1,1,0,0,0,0],
                 [0,1,1,1,1,1,1,1,1,1,1,0],
                 [1,1,1,1,1,1,1,1,1,1,1,1],
                 [1,1,1,0,0,1,1,0,0,1,1,1],
                 [1,1,1,1,1,1,1,1,1,1,1,1],
                 [0,0,1,1,1,0,0,1,1,1,0,0],
                 [0,1,1,0,0,1,1,0,0,1,1,0],
                 [0,0,1,1,0,0,0,0,1,1,0,0]]
            ],
            // Player cannon - 13x8
            player: [
                [0,0,0,0,0,0,1,0,0,0,0,0,0],
                [0,0,0,0,0,1,1,1,0,0,0,0,0],
                [0,0,0,0,0,1,1,1,0,0,0,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,1,0],
                [1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Player explosion - 16x8
            playerExplosion: [
                [[0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0],
                 [1,0,0,1,0,0,0,1,1,0,0,0,1,0,0,1],
                 [0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0],
                 [0,0,1,0,0,1,1,1,1,1,1,0,0,1,0,0],
                 [1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,1],
                 [0,0,1,0,0,1,1,1,1,1,1,0,0,1,0,0],
                 [0,1,0,1,0,1,0,1,1,0,1,0,1,0,1,0],
                 [1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1]],
                [[0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0],
                 [0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0],
                 [1,0,0,1,0,1,1,1,1,1,1,0,1,0,0,1],
                 [0,1,0,1,1,1,1,1,1,1,1,1,1,0,1,0],
                 [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
                 [1,1,0,1,1,1,1,1,1,1,1,1,1,0,1,1],
                 [0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0],
                 [0,1,0,1,0,0,0,1,1,0,0,0,1,0,1,0]]
            ],
            // Alien explosion - 13x8
            alienExplosion: [
                [0,0,0,0,0,0,1,0,0,0,0,0,0],
                [0,1,0,0,1,0,0,0,1,0,0,1,0],
                [0,0,1,0,0,1,0,1,0,0,1,0,0],
                [0,0,0,1,0,0,0,0,0,1,0,0,0],
                [1,1,0,0,0,0,0,0,0,0,0,1,1],
                [0,0,0,1,0,0,0,0,0,1,0,0,0],
                [0,0,1,0,0,1,0,1,0,0,1,0,0],
                [0,1,0,0,1,0,0,0,1,0,0,1,0]
            ],
            // UFO - 16x7
            ufo: [
                [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
                [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
                [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
                [0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [0,0,1,1,1,0,0,1,1,0,0,1,1,1,0,0],
                [0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0]
            ]
        };

        // Alien bullet types
        const bulletSprites = {
            // Plunger/squiggly bullet
            plunger: [
                [[0,1,0],[1,0,0],[0,1,0],[0,0,1]],
                [[0,0,1],[0,1,0],[1,0,0],[0,1,0]],
                [[0,1,0],[0,0,1],[0,1,0],[1,0,0]],
                [[1,0,0],[0,1,0],[0,0,1],[0,1,0]]
            ],
            // Rolling bullet
            rolling: [
                [[0,1,0],[1,1,1],[0,1,0],[0,1,0]],
                [[0,1,0],[0,1,0],[1,1,1],[0,1,0]],
                [[0,1,0],[0,1,0],[0,1,0],[1,1,1]],
                [[1,1,1],[0,1,0],[0,1,0],[0,1,0]]
            ]
        };

        // Input handling
        const keys = {};
        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            if (['Space', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.code)) {
                e.preventDefault();
            }
            if (e.code === 'Enter' && gameState === 'start') {
                startGame();
            }
            if (e.code === 'Enter' && gameState === 'gameover') {
                resetGame();
            }
        });
        document.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });

        // Sound effects using Web Audio API
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            switch(type) {
                case 'shoot':
                    oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(200, audioCtx.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.1);
                    break;
                case 'explosion':
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
                    gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    break;
                case 'invaderKilled':
                    oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.15);
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.15);
                    break;
                case 'ufo':
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.05);
                    break;
                case 'move':
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(60 + (alienAnimFrame * 20), audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.05);
                    break;
            }
        }

        // Initialize game
        function initAliens() {
            aliens = [];
            for (let row = 0; row < ALIEN_ROWS; row++) {
                for (let col = 0; col < ALIEN_COLS; col++) {
                    let type, points, width;
                    if (row === 0) {
                        type = 'squid';
                        points = 30;
                        width = 8;
                    } else if (row <= 2) {
                        type = 'crab';
                        points = 20;
                        width = 11;
                    } else {
                        type = 'octopus';
                        points = 10;
                        width = 12;
                    }
                    aliens.push({
                        x: 26 + col * ALIEN_SPACING_X,
                        y: 64 + row * ALIEN_SPACING_Y,
                        type: type,
                        width: width,
                        height: 8,
                        alive: true,
                        exploding: false,
                        explodeTimer: 0,
                        points: points
                    });
                }
            }
            alienDirection = 1;
            alienMoveDelay = BASE_ALIEN_MOVE_DELAY;
            lastAlienMoveFrame = 0;
        }

        function initShields() {
            shields = [];
            const shieldStartX = 32;
            const shieldSpacing = 45;
            for (let i = 0; i < SHIELD_COUNT; i++) {
                const shieldPixels = [];
                for (let y = 0; y < SHIELD_HEIGHT; y++) {
                    shieldPixels[y] = [];
                    for (let x = 0; x < SHIELD_WIDTH; x++) {
                        shieldPixels[y][x] = shieldPattern[y][x];
                    }
                }
                shields.push({
                    x: shieldStartX + i * shieldSpacing,
                    y: SHIELD_Y,
                    pixels: shieldPixels
                });
            }
        }

        function startGame() {
            gameState = 'playing';
            score = 0;
            lives = 3;
            level = 1;
            player.x = 112 - 8;
            player.alive = true;
            player.exploding = false;
            playerBullet.active = false;
            alienBullets.length = 0;
            initAliens();
            initShields();
            ufo.active = false;
            ufoTimer = 0;
            nextUfoSpawn = UFO_SPAWN_MIN + Math.random() * (UFO_SPAWN_MAX - UFO_SPAWN_MIN);
        }

        function resetGame() {
            gameState = 'start';
        }

        function nextLevel() {
            level++;
            playerBullet.active = false;
            alienBullets.length = 0;
            initAliens();
            // Increase difficulty - aliens start lower and move faster
            const startYOffset = Math.min((level - 1) * 8, 40);
            aliens.forEach(alien => {
                alien.y += startYOffset;
            });
            alienMoveDelay = Math.max(BASE_ALIEN_MOVE_DELAY - (level - 1) * 5, 10);
            ufo.active = false;
        }

        // Drawing functions
        function drawSprite(sprite, x, y, color = COLOR_WHITE) {
            ctx.fillStyle = color;
            for (let row = 0; row < sprite.length; row++) {
                for (let col = 0; col < sprite[row].length; col++) {
                    if (sprite[row][col]) {
                        ctx.fillRect(x + col, y + row, 1, 1);
                    }
                }
            }
        }

        function drawText(text, x, y, color = COLOR_WHITE, size = 8) {
            ctx.fillStyle = color;
            ctx.font = `${size}px 'Courier New'`;
            ctx.fillText(text, x, y);
        }

        function drawScore() {
            drawText('SCORE<1>', 16, 16, COLOR_WHITE);
            drawText('HI-SCORE', 88, 16, COLOR_WHITE);
            drawText('SCORE<2>', 160, 16, COLOR_WHITE);
            drawText(score.toString().padStart(4, '0'), 24, 28, COLOR_WHITE);
            drawText(highScore.toString().padStart(4, '0'), 96, 28, COLOR_WHITE);
        }

        function drawLives() {
            drawText(lives.toString(), 8, 240, COLOR_WHITE);
            for (let i = 0; i < lives - 1; i++) {
                drawSprite(sprites.player, 20 + i * 16, 232, COLOR_GREEN);
            }
            // Draw bottom line
            ctx.fillStyle = COLOR_GREEN;
            ctx.fillRect(0, 248, GAME_WIDTH, 1);
        }

        function drawPlayer() {
            if (player.exploding) {
                const frame = Math.floor(player.explodeFrame / 8) % 2;
                drawSprite(sprites.playerExplosion[frame], player.x - 2, player.y, COLOR_GREEN);
            } else if (player.alive) {
                drawSprite(sprites.player, player.x, player.y, COLOR_GREEN);
            }
        }

        function drawAliens() {
            aliens.forEach(alien => {
                if (alien.exploding) {
                    drawSprite(sprites.alienExplosion, alien.x - 2, alien.y, COLOR_WHITE);
                } else if (alien.alive) {
                    const sprite = sprites[alien.type][alienAnimFrame];
                    let color = COLOR_WHITE;
                    drawSprite(sprite, alien.x, alien.y, color);
                }
            });
        }

        function drawShields() {
            ctx.fillStyle = COLOR_GREEN;
            shields.forEach(shield => {
                for (let y = 0; y < SHIELD_HEIGHT; y++) {
                    for (let x = 0; x < SHIELD_WIDTH; x++) {
                        if (shield.pixels[y][x]) {
                            ctx.fillRect(shield.x + x, shield.y + y, 1, 1);
                        }
                    }
                }
            });
        }

        function drawBullets() {
            if (playerBullet.active) {
                ctx.fillStyle = COLOR_WHITE;
                ctx.fillRect(playerBullet.x, playerBullet.y, playerBullet.width, playerBullet.height);
            }
            alienBullets.forEach(bullet => {
                const sprite = bulletSprites[bullet.type][bullet.frame];
                drawSprite(sprite, bullet.x, bullet.y, COLOR_WHITE);
            });
        }

        function drawUFO() {
            if (ufo.active) {
                drawSprite(sprites.ufo, ufo.x, ufo.y, COLOR_RED);
            }
            if (ufoScoreDisplay.active) {
                drawText(ufoScoreDisplay.score.toString(), ufoScoreDisplay.x, ufo.y + 8, COLOR_RED);
            }
        }

        function drawStartScreen() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            drawText('PLAY', 88, 48, COLOR_WHITE);
            drawText('SPACE INVADERS', 56, 72, COLOR_GREEN);
            
            drawText('*SCORE ADVANCE TABLE*', 40, 112, COLOR_WHITE);
            
            // Draw alien types with scores
            drawSprite(sprites.ufo, 72, 128, COLOR_RED);
            drawText('=? MYSTERY', 96, 136, COLOR_WHITE);
            
            drawSprite(sprites.squid[0], 76, 152, COLOR_GREEN);
            drawText('=30 POINTS', 96, 160, COLOR_WHITE);
            
            drawSprite(sprites.crab[0], 74, 176, COLOR_CYAN);
            drawText('=20 POINTS', 96, 184, COLOR_WHITE);
            
            drawSprite(sprites.octopus[0], 72, 200, COLOR_MAGENTA);
            drawText('=10 POINTS', 96, 208, COLOR_WHITE);
            
            drawText('PRESS ENTER TO START', 40, 240, COLOR_WHITE);
        }

        function drawGameOver() {
            drawText('GAME OVER', 80, 128, COLOR_RED);
            drawText('PRESS ENTER', 72, 160, COLOR_WHITE);
        }

        // Game logic
        function updatePlayer() {
            if (!player.alive || player.exploding) {
                if (player.exploding) {
                    player.explodeFrame++;
                    if (player.explodeFrame > 32) {
                        player.exploding = false;
                        if (lives > 0) {
                            player.alive = true;
                            player.x = 112 - 8;
                        } else {
                            gameState = 'gameover';
                        }
                    }
                }
                return;
            }

            if (keys['ArrowLeft'] || keys['KeyA']) {
                player.x -= player.speed;
                if (player.x < 8) player.x = 8;
            }
            if (keys['ArrowRight'] || keys['KeyD']) {
                player.x += player.speed;
                if (player.x > GAME_WIDTH - 21) player.x = GAME_WIDTH - 21;
            }
            if (keys['Space'] && !playerBullet.active) {
                playerBullet.x = player.x + 6;
                playerBullet.y = player.y - 4;
                playerBullet.active = true;
                playSound('shoot');
            }
        }

        function updatePlayerBullet() {
            if (!playerBullet.active) return;
            
            playerBullet.y -= playerBullet.speed;
            
            if (playerBullet.y < 32) {
                playerBullet.active = false;
                return;
            }

            // Check collision with aliens
            for (let alien of aliens) {
                if (alien.alive && !alien.exploding) {
                    if (playerBullet.x >= alien.x && 
                        playerBullet.x < alien.x + alien.width &&
                        playerBullet.y >= alien.y && 
                        playerBullet.y < alien.y + alien.height) {
                        alien.alive = false;
                        alien.exploding = true;
                        alien.explodeTimer = 12;
                        playerBullet.active = false;
                        score += alien.points;
                        if (score > highScore) {
                            highScore = score;
                            localStorage.setItem('spaceInvadersHighScore', highScore);
                        }
                        playSound('invaderKilled');
                        
                        // Speed up remaining aliens
                        const aliveCount = aliens.filter(a => a.alive || a.exploding).length;
                        if (aliveCount > 0) {
                            alienMoveDelay = Math.max(3, Math.floor(BASE_ALIEN_MOVE_DELAY * aliveCount / 55));
                        }
                        return;
                    }
                }
            }

            // Check collision with UFO
            if (ufo.active) {
                if (playerBullet.x >= ufo.x && 
                    playerBullet.x < ufo.x + ufo.width &&
                    playerBullet.y >= ufo.y && 
                    playerBullet.y < ufo.y + ufo.height) {
                    ufo.active = false;
                    playerBullet.active = false;
                    const ufoScore = UFO_SCORES[ufoScoreIndex % UFO_SCORES.length];
                    ufoScoreIndex++;
                    score += ufoScore;
                    if (score > highScore) {
                        highScore = score;
                        localStorage.setItem('spaceInvadersHighScore', highScore);
                    }
                    ufoScoreDisplay.active = true;
                    ufoScoreDisplay.x = ufo.x;
                    ufoScoreDisplay.score = ufoScore;
                    ufoScoreDisplay.timer = 60;
                    playSound('explosion');
                    return;
                }
            }

            // Check collision with shields
            checkBulletShieldCollision(playerBullet, true);
        }

        function updateAliens() {
            // Update explosions
            aliens.forEach(alien => {
                if (alien.exploding) {
                    alien.explodeTimer--;
                    if (alien.explodeTimer <= 0) {
                        alien.exploding = false;
                    }
                }
            });

            // Check for level complete
            const aliveAliens = aliens.filter(a => a.alive || a.exploding);
            if (aliveAliens.length === 0) {
                nextLevel();
                return;
            }

            // Move aliens at intervals
            if (frameCount - lastAlienMoveFrame < alienMoveDelay) return;
            lastAlienMoveFrame = frameCount;

            // Toggle animation frame
            alienAnimFrame = 1 - alienAnimFrame;
            playSound('move');

            if (needToDrop) {
                aliens.forEach(alien => {
                    if (alien.alive) {
                        alien.y += alienDropAmount;
                        // Check if aliens reached player level
                        if (alien.y + alien.height >= player.y) {
                            gameState = 'gameover';
                        }
                    }
                });
                alienDirection *= -1;
                needToDrop = false;
            } else {
                let hitEdge = false;
                aliens.forEach(alien => {
                    if (alien.alive) {
                        alien.x += alienMoveAmount * alienDirection;
                        if (alien.x <= 8 || alien.x + alien.width >= GAME_WIDTH - 8) {
                            hitEdge = true;
                        }
                    }
                });
                if (hitEdge) {
                    needToDrop = true;
                }
            }
        }

        function updateAlienBullets() {
            // Fire new bullets
            alienShootTimer++;
            if (alienShootTimer >= ALIEN_SHOOT_DELAY && alienBullets.length < MAX_ALIEN_BULLETS) {
                const aliveAliens = aliens.filter(a => a.alive);
                if (aliveAliens.length > 0) {
                    // Find bottom-most aliens in each column
                    const columns = {};
                    aliveAliens.forEach(alien => {
                        const col = Math.floor((alien.x - 26) / ALIEN_SPACING_X);
                        if (!columns[col] || alien.y > columns[col].y) {
                            columns[col] = alien;
                        }
                    });
                    const bottomAliens = Object.values(columns);
                    const shooter = bottomAliens[Math.floor(Math.random() * bottomAliens.length)];
                    
                    alienBullets.push({
                        x: shooter.x + shooter.width / 2 - 1,
                        y: shooter.y + shooter.height,
                        type: Math.random() > 0.5 ? 'plunger' : 'rolling',
                        frame: 0,
                        speed: 2
                    });
                    alienShootTimer = 0;
                }
            }

            // Update existing bullets
            alienBullets.forEach((bullet, index) => {
                bullet.y += bullet.speed;
                bullet.frame = (bullet.frame + 1) % 4;

                // Check if out of bounds
                if (bullet.y > GAME_HEIGHT - 16) {
                    alienBullets.splice(index, 1);
                    return;
                }

                // Check collision with player
                if (player.alive && !player.exploding) {
                    if (bullet.x >= player.x && 
                        bullet.x < player.x + 13 &&
                        bullet.y >= player.y && 
                        bullet.y < player.y + 8) {
                        alienBullets.splice(index, 1);
                        player.alive = false;
                        player.exploding = true;
                        player.explodeFrame = 0;
                        lives--;
                        playSound('explosion');
                        return;
                    }
                }

                // Check collision with shields
                if (checkBulletShieldCollision(bullet, false)) {
                    alienBullets.splice(index, 1);
                }
            });
        }

        function checkBulletShieldCollision(bullet, isPlayerBullet) {
            for (let shield of shields) {
                const localX = Math.floor(bullet.x - shield.x);
                const localY = Math.floor(bullet.y - shield.y);
                
                if (localX >= 0 && localX < SHIELD_WIDTH && 
                    localY >= 0 && localY < SHIELD_HEIGHT) {
                    if (shield.pixels[localY] && shield.pixels[localY][localX]) {
                        // Destroy pixels in a small area
                        const radius = 3;
                        for (let dy = -radius; dy <= radius; dy++) {
                            for (let dx = -radius; dx <= radius; dx++) {
                                const py = localY + (isPlayerBullet ? dy - 2 : dy + 2);
                                const px = localX + dx;
                                if (py >= 0 && py < SHIELD_HEIGHT && 
                                    px >= 0 && px < SHIELD_WIDTH) {
                                    if (Math.abs(dx) + Math.abs(dy) <= radius) {
                                        shield.pixels[py][px] = 0;
                                    }
                                }
                            }
                        }
                        if (isPlayerBullet) {
                            playerBullet.active = false;
                        }
                        return true;
                    }
                }
            }
            return false;
        }

        function updateUFO() {
            if (ufo.active) {
                ufo.x += ufo.speed * ufo.direction;
                if (frameCount % 8 === 0) playSound('ufo');
                
                if (ufo.x < -16 || ufo.x > GAME_WIDTH + 16) {
                    ufo.active = false;
                }
            } else {
                ufoTimer++;
                if (ufoTimer >= nextUfoSpawn) {
                    ufo.active = true;
                    ufo.direction = Math.random() > 0.5 ? 1 : -1;
                    ufo.x = ufo.direction > 0 ? -16 : GAME_WIDTH + 16;
                    ufoTimer = 0;
                    nextUfoSpawn = UFO_SPAWN_MIN + Math.random() * (UFO_SPAWN_MAX - UFO_SPAWN_MIN);
                }
            }

            // Update score display
            if (ufoScoreDisplay.active) {
                ufoScoreDisplay.timer--;
                if (ufoScoreDisplay.timer <= 0) {
                    ufoScoreDisplay.active = false;
                }
            }
        }

        // Main game loop
        function gameLoop() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

            if (gameState === 'start') {
                drawStartScreen();
            } else if (gameState === 'playing') {
                frameCount++;
                
                updatePlayer();
                updatePlayerBullet();
                updateAliens();
                updateAlienBullets();
                updateUFO();

                drawScore();
                drawShields();
                drawAliens();
                drawPlayer();
                drawBullets();
                drawUFO();
                drawLives();
            } else if (gameState === 'gameover') {
                drawScore();
                drawShields();
                drawAliens();
                drawBullets();
                drawLives();
                drawGameOver();
            }

            requestAnimationFrame(gameLoop);
        }

        // Start the game loop
        gameLoop();
    </script>
</body>
</html>
