<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Invaders - 1978 Replica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: monospace;
        }
        #gameContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        canvas {
            border: 2px solid #0f0;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        #info {
            color: #0f0;
            margin-top: 10px;
            font-size: 14px;
        }
        #controls {
            color: #0f0;
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="game" width="224" height="256"></canvas>
        <div id="info"></div>
        <div id="controls">
            <p>CONTROLS: LEFT/RIGHT ARROWS = Move | SPACE = Fire | ENTER = Start/Restart</p>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const info = document.getElementById('info');

        const SCALE = 2;
        canvas.style.width = (224 * SCALE) + 'px';
        canvas.style.height = (256 * SCALE) + 'px';

        const GAME_WIDTH = 224;
        const GAME_HEIGHT = 256;

        const ALIEN_ROWS = 5;
        const ALIEN_COLS = 11;
        const ALIEN_WIDTH = 12;
        const ALIEN_HEIGHT = 8;
        const ALIEN_SPACING_X = 16;
        const ALIEN_SPACING_Y = 16;

        const PLAYER_WIDTH = 13;
        const PLAYER_HEIGHT = 8;
        const PLAYER_Y = 216;
        const PLAYER_SPEED = 2;

        const BULLET_WIDTH = 1;
        const BULLET_HEIGHT = 4;
        const BULLET_SPEED = 4;

        const ALIEN_BULLET_SPEED = 2;

        const SHIELD_COUNT = 4;
        const SHIELD_WIDTH = 22;
        const SHIELD_HEIGHT = 16;
        const SHIELD_Y = 192;

        const UFO_WIDTH = 16;
        const UFO_HEIGHT = 7;
        const UFO_Y = 32;
        const UFO_SPEED = 1;

        const SPRITE_DATA = {
            squid1: [
                '    ##    ',
                '   ####   ',
                '  ######  ',
                ' ## ## ## ',
                ' ######## ',
                '   #  #   ',
                '  # ## #  ',
                ' #      # '
            ],
            squid2: [
                '    ##    ',
                '   ####   ',
                '  ######  ',
                ' ## ## ## ',
                ' ######## ',
                '  #    #  ',
                '   #  #   ',
                '  #    #  '
            ],
            crab1: [
                '  #     #  ',
                '   #   #   ',
                '  #######  ',
                ' ## ### ## ',
                '###########',
                '# ####### #',
                '# #     # #',
                '   ## ##   '
            ],
            crab2: [
                '  #     #  ',
                '#  #   #  #',
                '# ####### #',
                '### ### ###',
                '###########',
                ' ######### ',
                '  #     #  ',
                ' #       # '
            ],
            octopus1: [
                '   ####   ',
                ' ######## ',
                '##########',
                '###  #  ###',
                '##########',
                '  ### ### ',
                ' ##  #  ##',
                '##      ##'
            ],
            octopus2: [
                '   ####   ',
                ' ######## ',
                '##########',
                '###  #  ###',
                '##########',
                '  ### ### ',
                ' ##     ##',
                '  ##   ## '
            ],
            player: [
                '      #      ',
                '     ###     ',
                '     ###     ',
                ' ########### ',
                '#############',
                '#############',
                '#############',
                '#############'
            ],
            ufo: [
                '     ######     ',
                '   ##########   ',
                '  ############  ',
                ' ## ## ## ## ## ',
                '################',
                '  ###  ##  ###  ',
                '   #        #   '
            ],
            explosion: [
                ' #   #   # ',
                '  #  #  #  ',
                '   # # #   ',
                '### ### ###',
                '   # # #   ',
                '  #  #  #  ',
                ' #   #   # '
            ]
        };

        const SHIELD_SPRITE = [
            '    ######    ',
            '   ########   ',
            '  ##########  ',
            ' ############ ',
            '##############',
            '##############',
            '##############',
            '##############',
            '##############',
            '##############',
            '##############',
            '##############',
            '####      ####',
            '###        ###',
            '##          ##',
            '##          ##'
        ];

        const UFO_SCORES = [100, 50, 50, 100, 150, 100, 100, 50, 300, 100, 100, 100, 50, 150, 100, 50];

        let gameState = 'start';
        let score = 0;
        let highScore = 0;
        let lives = 3;
        let level = 1;

        let player = { x: GAME_WIDTH / 2 - PLAYER_WIDTH / 2, y: PLAYER_Y };
        let playerBullet = null;
        let alienBullets = [];
        let aliens = [];
        let alienDirection = 1;
        let alienMoveTimer = 0;
        let alienMoveDelay = 60;
        let alienAnimFrame = 0;
        let aliensToMove = 0;
        let currentAlienIndex = 0;
        let alienDropping = false;

        let shields = [];
        let ufo = null;
        let ufoTimer = 0;
        let ufoDirection = 1;
        let shotsFired = 0;

        let explosions = [];
        let playerExplosion = null;
        let playerRespawnTimer = 0;

        let keys = { left: false, right: false, fire: false };
        let canFire = true;

        function parseSprite(spriteData) {
            const pixels = [];
            for (let y = 0; y < spriteData.length; y++) {
                for (let x = 0; x < spriteData[y].length; x++) {
                    if (spriteData[y][x] === '#') {
                        pixels.push({ x, y });
                    }
                }
            }
            return pixels;
        }

        const sprites = {};
        for (const key in SPRITE_DATA) {
            sprites[key] = parseSprite(SPRITE_DATA[key]);
        }
        const shieldSprite = parseSprite(SHIELD_SPRITE);

        function drawSprite(pixels, x, y, color) {
            ctx.fillStyle = color;
            for (const p of pixels) {
                ctx.fillRect(x + p.x, y + p.y, 1, 1);
            }
        }

        function initAliens() {
            aliens = [];
            const startX = 26;
            const startY = 64;

            for (let row = 0; row < ALIEN_ROWS; row++) {
                for (let col = 0; col < ALIEN_COLS; col++) {
                    let type, points;
                    if (row === 0) {
                        type = 'squid';
                        points = 30;
                    } else if (row <= 2) {
                        type = 'crab';
                        points = 20;
                    } else {
                        type = 'octopus';
                        points = 10;
                    }

                    aliens.push({
                        x: startX + col * ALIEN_SPACING_X,
                        y: startY + row * ALIEN_SPACING_Y,
                        type,
                        points,
                        alive: true
                    });
                }
            }

            alienDirection = 1;
            alienMoveDelay = Math.max(10, 60 - (level - 1) * 5);
            alienMoveTimer = 0;
            currentAlienIndex = 0;
            alienDropping = false;
        }

        function initShields() {
            shields = [];
            const shieldGap = (GAME_WIDTH - SHIELD_COUNT * SHIELD_WIDTH) / (SHIELD_COUNT + 1);

            for (let i = 0; i < SHIELD_COUNT; i++) {
                const shieldX = shieldGap + i * (SHIELD_WIDTH + shieldGap);
                const pixels = new Set();

                for (const p of shieldSprite) {
                    pixels.add(`${p.x},${p.y}`);
                }

                shields.push({
                    x: shieldX,
                    y: SHIELD_Y,
                    pixels
                });
            }
        }

        function initGame() {
            score = 0;
            lives = 3;
            level = 1;
            shotsFired = 0;
            player.x = GAME_WIDTH / 2 - PLAYER_WIDTH / 2;
            playerBullet = null;
            alienBullets = [];
            explosions = [];
            playerExplosion = null;
            playerRespawnTimer = 0;
            ufo = null;
            ufoTimer = 0;
            initAliens();
            initShields();
            gameState = 'playing';
        }

        function nextLevel() {
            level++;
            playerBullet = null;
            alienBullets = [];
            explosions = [];
            ufo = null;
            ufoTimer = 0;
            initAliens();
        }

        function getAlienSprite(alien) {
            const frame = alienAnimFrame % 2;
            if (alien.type === 'squid') {
                return frame === 0 ? sprites.squid1 : sprites.squid2;
            } else if (alien.type === 'crab') {
                return frame === 0 ? sprites.crab1 : sprites.crab2;
            } else {
                return frame === 0 ? sprites.octopus1 : sprites.octopus2;
            }
        }

        function moveAliens() {
            const aliveAliens = aliens.filter(a => a.alive);
            if (aliveAliens.length === 0) return;

            alienMoveDelay = Math.max(2, Math.floor(60 * aliveAliens.length / 55) - (level - 1) * 3);

            alienMoveTimer++;
            if (alienMoveTimer < alienMoveDelay / aliveAliens.length) return;
            alienMoveTimer = 0;

            if (alienDropping) {
                for (const alien of aliveAliens) {
                    alien.y += 8;
                }
                alienDirection *= -1;
                alienDropping = false;
                alienAnimFrame++;
                return;
            }

            let needDrop = false;
            for (const alien of aliveAliens) {
                alien.x += alienDirection * 2;
                if (alien.x <= 10 || alien.x >= GAME_WIDTH - 22) {
                    needDrop = true;
                }
            }

            if (needDrop) {
                for (const alien of aliveAliens) {
                    alien.x -= alienDirection * 2;
                }
                alienDropping = true;
            }

            alienAnimFrame++;
        }

        function alienShoot() {
            if (alienBullets.length >= 3) return;
            if (Math.random() > 0.02) return;

            const aliveAliens = aliens.filter(a => a.alive);
            if (aliveAliens.length === 0) return;

            const cols = {};
            for (const alien of aliveAliens) {
                const col = Math.floor((alien.x - 26) / ALIEN_SPACING_X);
                if (!cols[col] || alien.y > cols[col].y) {
                    cols[col] = alien;
                }
            }

            const bottomAliens = Object.values(cols);
            const shooter = bottomAliens[Math.floor(Math.random() * bottomAliens.length)];

            alienBullets.push({
                x: shooter.x + 5,
                y: shooter.y + ALIEN_HEIGHT,
                type: Math.floor(Math.random() * 3)
            });
        }

        function updateUFO() {
            if (!ufo) {
                ufoTimer++;
                if (ufoTimer > 600 && Math.random() < 0.005) {
                    ufoDirection = Math.random() < 0.5 ? 1 : -1;
                    ufo = {
                        x: ufoDirection > 0 ? -UFO_WIDTH : GAME_WIDTH,
                        y: UFO_Y
                    };
                    ufoTimer = 0;
                }
            } else {
                ufo.x += UFO_SPEED * ufoDirection;
                if (ufo.x < -UFO_WIDTH || ufo.x > GAME_WIDTH) {
                    ufo = null;
                }
            }
        }

        function checkCollision(x1, y1, w1, h1, x2, y2, w2, h2) {
            return x1 < x2 + w2 && x1 + w1 > x2 && y1 < y2 + h2 && y1 + h1 > y2;
        }

        function damageShield(shield, bx, by, bw, bh) {
            let hit = false;
            const toRemove = [];

            for (const key of shield.pixels) {
                const [px, py] = key.split(',').map(Number);
                const worldX = shield.x + px;
                const worldY = shield.y + py;

                if (worldX >= bx && worldX < bx + bw && worldY >= by && worldY < by + bh) {
                    toRemove.push(key);
                    hit = true;
                }
            }

            for (const key of toRemove) {
                shield.pixels.delete(key);
                for (let dx = -2; dx <= 2; dx++) {
                    for (let dy = -2; dy <= 2; dy++) {
                        if (Math.random() < 0.5) {
                            const [px, py] = key.split(',').map(Number);
                            shield.pixels.delete(`${px + dx},${py + dy}`);
                        }
                    }
                }
            }

            return hit;
        }

        function update() {
            if (gameState !== 'playing') return;

            if (playerRespawnTimer > 0) {
                playerRespawnTimer--;
                if (playerRespawnTimer === 0) {
                    playerExplosion = null;
                    player.x = GAME_WIDTH / 2 - PLAYER_WIDTH / 2;
                }
                return;
            }

            if (keys.left && player.x > 2) {
                player.x -= PLAYER_SPEED;
            }
            if (keys.right && player.x < GAME_WIDTH - PLAYER_WIDTH - 2) {
                player.x += PLAYER_SPEED;
            }

            if (keys.fire && canFire && !playerBullet) {
                playerBullet = {
                    x: player.x + PLAYER_WIDTH / 2,
                    y: player.y - BULLET_HEIGHT
                };
                shotsFired++;
                canFire = false;
            }
            if (!keys.fire) {
                canFire = true;
            }

            if (playerBullet) {
                playerBullet.y -= BULLET_SPEED;
                if (playerBullet.y < 30) {
                    playerBullet = null;
                }
            }

            if (playerBullet) {
                for (const alien of aliens) {
                    if (!alien.alive) continue;
                    if (checkCollision(
                        playerBullet.x, playerBullet.y, BULLET_WIDTH, BULLET_HEIGHT,
                        alien.x, alien.y, ALIEN_WIDTH, ALIEN_HEIGHT
                    )) {
                        alien.alive = false;
                        score += alien.points;
                        if (score > highScore) highScore = score;

                        if (score >= 1500 && score - alien.points < 1500) {
                            lives++;
                        }

                        explosions.push({
                            x: alien.x,
                            y: alien.y,
                            timer: 15
                        });
                        playerBullet = null;
                        break;
                    }
                }
            }

            if (playerBullet && ufo) {
                if (checkCollision(
                    playerBullet.x, playerBullet.y, BULLET_WIDTH, BULLET_HEIGHT,
                    ufo.x, ufo.y, UFO_WIDTH, UFO_HEIGHT
                )) {
                    const ufoScore = UFO_SCORES[(shotsFired - 1) % UFO_SCORES.length];
                    score += ufoScore;
                    if (score > highScore) highScore = score;

                    explosions.push({
                        x: ufo.x,
                        y: ufo.y,
                        timer: 30,
                        score: ufoScore
                    });
                    ufo = null;
                    playerBullet = null;
                }
            }

            if (playerBullet) {
                for (const shield of shields) {
                    if (damageShield(shield, playerBullet.x, playerBullet.y, BULLET_WIDTH, BULLET_HEIGHT)) {
                        playerBullet = null;
                        break;
                    }
                }
            }

            moveAliens();
            alienShoot();
            updateUFO();

            for (let i = alienBullets.length - 1; i >= 0; i--) {
                const bullet = alienBullets[i];
                bullet.y += ALIEN_BULLET_SPEED;

                if (bullet.y > GAME_HEIGHT) {
                    alienBullets.splice(i, 1);
                    continue;
                }

                for (const shield of shields) {
                    if (damageShield(shield, bullet.x - 1, bullet.y, 3, 4)) {
                        alienBullets.splice(i, 1);
                        break;
                    }
                }
            }

            if (playerRespawnTimer === 0) {
                for (let i = alienBullets.length - 1; i >= 0; i--) {
                    const bullet = alienBullets[i];
                    if (checkCollision(
                        bullet.x - 1, bullet.y, 3, 4,
                        player.x, player.y, PLAYER_WIDTH, PLAYER_HEIGHT
                    )) {
                        lives--;
                        alienBullets.splice(i, 1);
                        playerExplosion = { x: player.x, y: player.y, timer: 60 };
                        playerRespawnTimer = 120;

                        if (lives <= 0) {
                            gameState = 'gameover';
                        }
                        break;
                    }
                }
            }

            for (let i = explosions.length - 1; i >= 0; i--) {
                explosions[i].timer--;
                if (explosions[i].timer <= 0) {
                    explosions.splice(i, 1);
                }
            }

            const aliveAliens = aliens.filter(a => a.alive);
            if (aliveAliens.length === 0) {
                nextLevel();
            }

            for (const alien of aliveAliens) {
                if (alien.y >= PLAYER_Y - ALIEN_HEIGHT) {
                    gameState = 'gameover';
                    break;
                }
            }
        }

        function drawText(text, x, y, color = '#fff') {
            ctx.fillStyle = color;
            ctx.font = '8px monospace';
            ctx.fillText(text, x, y);
        }

        function draw() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

            drawText('SCORE<1>', 8, 16, '#fff');
            drawText(String(score).padStart(4, '0'), 16, 26, '#fff');

            drawText('HI-SCORE', 80, 16, '#fff');
            drawText(String(highScore).padStart(4, '0'), 88, 26, '#fff');

            drawText('SCORE<2>', 168, 16, '#fff');

            if (gameState === 'start') {
                drawText('SPACE INVADERS', 64, 100, '#fff');
                drawText('PRESS ENTER TO START', 40, 140, '#0f0');

                drawText('*SCORE ADVANCE TABLE*', 48, 170, '#fff');
                drawSprite(sprites.squid1, 80, 180, '#fff');
                drawText('= 30 POINTS', 100, 186, '#fff');
                drawSprite(sprites.crab1, 78, 195, '#fff');
                drawText('= 20 POINTS', 100, 201, '#fff');
                drawSprite(sprites.octopus1, 78, 210, '#fff');
                drawText('= 10 POINTS', 100, 216, '#fff');
                drawSprite(sprites.ufo, 72, 225, '#f00');
                drawText('= ? MYSTERY', 100, 231, '#fff');
                return;
            }

            if (gameState === 'gameover') {
                drawText('GAME OVER', 80, 128, '#f00');
                drawText('PRESS ENTER TO RESTART', 32, 150, '#0f0');
            }

            if (ufo) {
                drawSprite(sprites.ufo, ufo.x, ufo.y, '#f00');
            }

            for (const alien of aliens) {
                if (!alien.alive) continue;
                const sprite = getAlienSprite(alien);
                const color = alien.type === 'squid' ? '#fff' : alien.type === 'crab' ? '#0ff' : '#0f0';
                drawSprite(sprite, alien.x, alien.y, color);
            }

            for (const shield of shields) {
                ctx.fillStyle = '#0f0';
                for (const key of shield.pixels) {
                    const [px, py] = key.split(',').map(Number);
                    ctx.fillRect(shield.x + px, shield.y + py, 1, 1);
                }
            }

            if (playerRespawnTimer === 0 || Math.floor(playerRespawnTimer / 10) % 2 === 0) {
                if (!playerExplosion || playerExplosion.timer < 60) {
                    drawSprite(sprites.player, player.x, player.y, '#0f0');
                }
            }

            if (playerExplosion) {
                drawSprite(sprites.explosion, playerExplosion.x, playerExplosion.y, '#f00');
            }

            if (playerBullet) {
                ctx.fillStyle = '#fff';
                ctx.fillRect(playerBullet.x, playerBullet.y, BULLET_WIDTH, BULLET_HEIGHT);
            }

            for (const bullet of alienBullets) {
                ctx.fillStyle = '#fff';
                if (bullet.type === 0) {
                    ctx.fillRect(bullet.x, bullet.y, 1, 4);
                } else if (bullet.type === 1) {
                    ctx.fillRect(bullet.x - 1, bullet.y, 3, 1);
                    ctx.fillRect(bullet.x, bullet.y + 1, 1, 2);
                    ctx.fillRect(bullet.x - 1, bullet.y + 3, 3, 1);
                } else {
                    ctx.fillRect(bullet.x, bullet.y, 1, 1);
                    ctx.fillRect(bullet.x - 1, bullet.y + 1, 1, 1);
                    ctx.fillRect(bullet.x + 1, bullet.y + 1, 1, 1);
                    ctx.fillRect(bullet.x, bullet.y + 2, 1, 1);
                    ctx.fillRect(bullet.x - 1, bullet.y + 3, 1, 1);
                    ctx.fillRect(bullet.x + 1, bullet.y + 3, 1, 1);
                }
            }

            for (const exp of explosions) {
                if (exp.score) {
                    drawText(String(exp.score), exp.x, exp.y + 8, '#fff');
                } else {
                    drawSprite(sprites.explosion, exp.x, exp.y, '#fff');
                }
            }

            ctx.fillStyle = '#0f0';
            ctx.fillRect(0, 240, GAME_WIDTH, 1);

            for (let i = 0; i < lives - 1; i++) {
                drawSprite(sprites.player, 20 + i * 16, 244, '#0f0');
            }
            drawText(String(lives), 8, 250, '#fff');

            drawText('CREDIT 00', 136, 250, '#fff');
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') keys.left = true;
            if (e.key === 'ArrowRight') keys.right = true;
            if (e.key === ' ') {
                keys.fire = true;
                e.preventDefault();
            }
            if (e.key === 'Enter') {
                if (gameState === 'start' || gameState === 'gameover') {
                    initGame();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft') keys.left = false;
            if (e.key === 'ArrowRight') keys.right = false;
            if (e.key === ' ') keys.fire = false;
        });

        gameLoop();
    })();
    </script>
</body>
</html>
